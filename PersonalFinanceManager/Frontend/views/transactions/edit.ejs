<div class="row mt-5">
    <div class="col-md-8 m-auto">
        <div class="card card-body bg-secondary text-light">
            <h1 class="text-center mb-3 text-light">Edytuj Transakcję</h1>
            <%# Zmiana ._id na .id dla konta i transakcji %>
            <form action="/accounts/<%= account.id %>/transactions/edit/<%= transaction.id %>" method="POST">
                <div class="mb-3">
                    <label for="type" class="form-label">Typ Transakcji</label>
                    <select id="type" name="type" class="form-select" required onchange="toggleTransactionFields()">
                        <option value="expense" <%= transaction.type === 'expense' || transaction.type === 1 ? 'selected' : '' %>>Wydatek</option>
                        <option value="income" <%= transaction.type === 'income' || transaction.type === 0 ? 'selected' : '' %>>Przychód</option>
                        <option value="transfer" <%= transaction.type === 'transfer' ? 'selected' : '' %>>Transfer</option>
                    </select>
                </div>

                <div class="mb-3" id="categoryField">
                    <label for="category" class="form-label">Kategoria</label>
                    <select id="category" name="category" class="form-select">
                        <option value="">Wybierz kategorię</option>
                        <% categories.forEach(cat => { %>
                            <%# Porównanie id transakcji z id kategorii %>
                            <option value="<%= cat.id %>" <%= transaction.categoryId == cat.id || transaction.category == cat.id ? 'selected' : '' %>>
                                <%= cat.name %>
                            </option>
                        <% }) %>
                    </select>
                </div>

                <div class="mb-3" id="senderAccountField" style="display: none;">
                    <label for="senderAccountId" class="form-label">Konto Nadawcy</label>
                    <select id="senderAccountId" name="senderAccountId" class="form-select">
                        <option value="<%= account.id %>" selected><%= account.name %></option>
                    </select>
                </div>

                <div class="mb-3" id="receiverAccountField" style="display: none;">
                    <label for="receiverAccountId" class="form-label">Konto Odbiorcy</label>
                    <select id="receiverAccountId" name="receiverAccountId" class="form-select">
                        <option value="">Wybierz konto odbiorcy</option>
                        <% if (typeof userAccounts !== 'undefined') { %>
                            <% userAccounts.forEach(acc => { %>
                                <option value="<%= acc.id %>" <%= transaction.receiverAccountId == acc.id ? 'selected' : '' %>>
                                    <%= acc.name %>
                                </option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="amount" class="form-label">Kwota (<%= account.currencyCode || account.currency %>)</label>
                    <input
                        type="number"
                        id="amount"
                        name="amount"
                        class="form-control"
                        step="0.01"
                        value="<%= Number(transaction.amount).toFixed(2) %>"
                        required
                    />
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Opis (opcjonalnie)</label>
                    <textarea
                        id="description"
                        name="description"
                        class="form-control"
                        rows="3"
                        placeholder="Krótki opis transakcji"
                    ><%= transaction.description || '' %></textarea>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Zapisz Zmiany</button>
                    <a href="/accounts/<%= account.id %>/transactions" class="btn btn-secondary">Anuluj</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleTransactionFields() {
        const type = document.getElementById('type').value;
        const categoryField = document.getElementById('categoryField');
        const senderAccountField = document.getElementById('senderAccountField');
        const receiverAccountField = document.getElementById('receiverAccountField');
        const categorySelect = document.getElementById('category');

        if (type === 'transfer') {
            categoryField.style.display = 'none';
            senderAccountField.style.display = 'block';
            receiverAccountField.style.display = 'block';
            categorySelect.removeAttribute('required');
        } else {
            categoryField.style.display = 'block';
            senderAccountField.style.display = 'none';
            receiverAccountField.style.display = 'none';
            categorySelect.setAttribute('required', 'required');
        }
    }
    document.addEventListener('DOMContentLoaded', toggleTransactionFields);
</script>